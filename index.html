<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .f {
            display: flex;
        }

        .w-100 {
            width: 100%;
        }

        .h-100 {
            height: 100%;
        }

        .w-100-i {
            width: 100% !important;
        }

        .h-100-i {
            height: 100% !important;
        }

        .pos-abs {
            position: absolute;
        }

        .pos-rel {
            position: relative;
        }

        .hide {
            display: none;
        }
    </style>
</head>

<body>
    <script>

        //#region autoload elements
        const autoLoadCSSClass = "autoload";
        let elements = {};
        function loadElements() {
            elements = {}
            document.querySelectorAll("." + autoLoadCSSClass)
                .forEach(el => {
                    const id = el.id;
                    if (id == null) {
                        console.warn("element doesn't have an id", el);
                        return;
                    }
                    if (id != null) {
                        elements[id] = el;
                    }
                });
        }
        //#endregion

        //#region utils
        function getFuncOrVal(funcOrVal, ...args) {
            if (typeof func == "function") {
                return func(...args);
            }
            return func;
        }
        function setInner(querySelector, innerHTML) {
            const element = document.querySelector(querySelector);
            if (element == null) {
                console.warn("element is null");
            } else {
                element.innerHTML = innerHTML;
            }
        }
        //#endregion

        //#region code running

        //#region code utils
        function funcToEvalStr(func) {
            return joinEval(func.toString(), func.name + "()");
        }
        function joinEval(...parts) {
            return parts.join(";");
        }
        //#endregion

        function thingsToRunBefore() {
            Object.assign(globalThis, elements);
        }

        function runCode(code) {
            const codePrefix = funcToEvalStr(thingsToRunBefore);
            const wholeCode = joinEval(codePrefix, code);
            console.log("running code \n", wholeCode)
            eval.bind(this)(wholeCode);
        }
        //#endregion

        //#region cookies
        function _setCookie(cname, cvalue, exdays = 7) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }
        function getAllRawCookies() {
            return document.cookie;
        }

        //#region map
        const jsonToken = "jsonToken:"
        let cookieMap = {};

        function setCookieToMap(name, val, expires = 1) {
            cookieMap[name] = {
                type: "extended",
                name: name,
                value: val,
                expires: expires,
                toSet: true
            };
        }
        function getCookieFromMap(name) {
            return cookieMap[name];
        }

        function maybeSimpleCookieToExtendCookie(cookie) {
            if (typeof cookie == "object"
                && "type" in cookie
                && cookie.type == "extended"
            ) {
                return cookie;
            }
            const trimmed = cookie.trim();
            let [name, ...rest] = trimmed.split("=");
            const value = rest.join("=");
            let index = value.indexOf(jsonToken);
            if (index == 0) {
                const jsonText = value.substring(index + jsonToken.length);
                const obj = JSON.parse(jsonText);
                return obj;
            }
            return simpleCookieToExtendCookie(name, value)

        }
        function simpleCookieToExtendCookie(name, value) {
            return {
                type: "simple",
                name: name,
                value: value,
                expires: null
            };
        }

        function getCookieMap() {
            let cookiesMap = {};
            let decodedCookie = decodeURIComponent(getAllRawCookies());
            let cookies = decodedCookie.split(';');
            cookies.forEach((cookie, i) => {
                debugger;
                const betterCookie = maybeSimpleCookieToExtendCookie(cookie);
                cookiesMap[betterCookie.name] = betterCookie;
            })
            return cookiesMap;
        }
        function setCookieMap(cookieMap) {
            const entries = Object.entries(cookieMap);
            entries.forEach(([key, cookie], i) => {
                if (key != cookie.name) {
                    throw new Error("ups" + key + "!=" + cookie.name);
                }
                if (cookie?.toSet === true) {
                    _setCookie(cookie.name, jsonToken + JSON.stringify(cookie), cookie.expires);
                }
            });
        }

        function loadCookieMap() {
            cookieMap = getCookieMap();
        }
        function uploadCookieMap() {
            setCookieMap(cookieMap)
        }
        //#endregion map

        //#endregion cookies

        //#region localStorage
        const localStorageKey = "jsTesterPage";
        function joinKeys(...args) {
            return args.join(".");
        }
        function setToStorage(key, value) {
            let json = undefined;
            if (value != null) {
                json = JSON.stringify(value);
            }
            localStorage.setItem(joinKeys(localStorageKey, key), json);
        }
        function getFromStorage(key) {
            const value = localStorage.getItem(joinKeys(localStorageKey, key));
            if (value == null) {
                return value;
            }
            try {
                return JSON.parse(value)
            } catch (e) {
                console.warn("returning undefined,json error", e);
            }
            return undefined;
        }

        //#endregion

        //#region eventListeners
        const eventListenersMap = {};
        function addEvent(what, func) {
            const arr = eventListenersMap[what] ?? [];
            arr.push(func);
            addEventListener(what, func);
        }
        function onBeforeUnload(event) {
            Object.entries(eventListenersMap)
                .forEach(([key, values], i) => {
                    values.forEach(listener => removeEventListener(key, values))
                });
        }
        addEventListener("beforeunload", onBeforeUnload);
        //#endregion

        //#region set code text
        function getCodeText() {
            const codeElement = elements["code"];
            const code = codeElement?.value;
            if (code == null) {
                console.warn("input text is null", code, codeElement);
                return undefined;
            }
            return code;
        }
        function setCodeText(code) {
            const codeElement = elements["code"];
            if (codeElement == null) {
                console.warn("input  is null", codeElement);
                return;
            }
            codeElement.value = code;

        }
        function setCodeTextFromCookies() {
            const code = cookieMap["code"];
            if (code?.value != null) {
                setCodeText(code.value);
            }
        }
        //#endregion


        function deferMain() {
            loadElements();
            setCodeTextFromCookies();
        }
        function onQuit(e) {
            debugger;
            let code = getCodeText();
            if (code == null) {
                code = "";
                console.warn("code is null, setting to empty text", code);
            }
            setCookieToMap("code", code);

            uploadCookieMap();
        }

        addEvent("beforeunload", onQuit)

        loadCookieMap();
    </script>
    <script>
        //element funcs
        var count = 0;
        function add() {
            count++;
        }
        function runCodeFunc() {
            const code = getCodeText();
            if (code == null) {
                console.warn("code to run is null", code);
                return;
            }
            runCode(code);
        }
    </script>

    <div class="hide">
        <button class="autoload" id="clicker" onclick="add();setInner('#clicker',count)">click</button>
    </div>
    <div class="f pos-rel">
        <textarea style="height:200px" class="autoload w-100-i h-100" id="code"></textarea>
        <button style="right:10px; bottom:10px" class="autoload pos-abs" id="run" onclick="runCodeFunc()">
            Run Code
        </button>
    </div>
    <div class="autoload" id="output">
        *output here*
    </div>
    <script defer>
        deferMain();
    </script>
    <div class="hide">
        <button onclick="loadCookieMap()">loadCookieMap</button>
        <button onclick="setCookieToMap('a',Math.random(),7)">setCookieToMap</button>
        <button onclick="uploadCookieMap()">uploadCookieMap</button>
        <button onclick="console.log(getCookieToMap('a'))">getCookieToMap</button>
        <button onclick="console.log(cookieMap)">cookieMap</button>

        <button onclick="console.log(getAllRawCookies())">getAllRawCookies</button>
    </div>
    <button onclick="onQuit(undefined)">onQuit</button>
</body>

</html>